<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Portfolio Book</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background: #ffffff;
        }

        #book {
            transition: transform 280ms cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
            transform: translateX(0);
            transform-origin: center center;
        }

        .flipbook-wrapper {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page {
            padding: 0;
            background-color: #fdfdfd;
        }

        .page img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>

<body>

    <div class="flipbook-wrapper">
        <div id="book">
        <div class="page"><img src="images/books/1.jpg" alt="Cover"></div>
        <div class="page"><img src="images/books/2.jpg" alt="Page 2"></div>
        <div class="page"><img src="images/books/3.jpg" alt="Page 3"></div>
        <div class="page"><img src="images/books/4.jpg" alt="Page 4"></div>
        <div class="page"><img src="images/books/5.jpg" alt="Page 5"></div>
        <div class="page"><img src="images/books/6.jpg" alt="Page 6"></div>
        <div class="page"><img src="images/books/7.jpg" alt="Page 7"></div>
        <div class="page"><img src="images/books/8.jpg" alt="Page 8"></div>
        <div class="page" data-density="hard"><img src="images/books/9.jpg" alt="Back Cover"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const bookEl = document.getElementById('book');
            const pages = bookEl.querySelectorAll('.page');

            const pageFlip = new St.PageFlip(bookEl, {
                width: 420,
                height: 560,
                size: 'stretch',
                minWidth: 320,
                maxWidth: 900,
                minHeight: 420,
                maxHeight: 1200,
                maxShadowOpacity: 0.2,
                showCover: true,
                mobileScrollSupport: true,
                flippingTime: 600
            });

            pageFlip.loadFromHTML(pages);

            let appliedOffset = 0;
            let scheduled = false;

            const measureAndCenter = () => {
                scheduled = false;

                const wrapperEl = bookEl.closest('.flipbook-wrapper');
                if (!wrapperEl) return;

                const wrapperRect = wrapperEl.getBoundingClientRect();

                const visibleRects = [];
                pages.forEach((p) => {
                    const rect = p.getBoundingClientRect();
                    if (rect.width < 5 || rect.height < 5) return;

                    const overlap = Math.min(rect.right, wrapperRect.right) - Math.max(rect.left, wrapperRect.left);
                    if (overlap <= rect.width * 0.2) return;

                    const style = window.getComputedStyle(p);
                    if (style.visibility === 'hidden') return;
                    if (parseFloat(style.opacity || '1') < 0.05) return;

                    visibleRects.push(rect);
                });

                let targetOffset = 0;

                if (visibleRects.length > 0) {
                    const left = Math.min(...visibleRects.map(r => r.left));
                    const right = Math.max(...visibleRects.map(r => r.right));
                    const visibleCenterX = (left + right) / 2;
                    const wrapperCenterX = (wrapperRect.left + wrapperRect.right) / 2;
                    const delta = wrapperCenterX - visibleCenterX;

                    appliedOffset = appliedOffset + delta;
                    if (Math.abs(delta) < 0.5) appliedOffset = appliedOffset;
                    targetOffset = appliedOffset;
                } else {
                    const parent = bookEl.querySelector('.stf__parent');
                    if (!parent) return;

                    const spreadWidth = parent.offsetWidth;
                    const current = pageFlip.getCurrentPageIndex();
                    const last = pageFlip.getPageCount() - 1;

                    if (current === 0) targetOffset = -(spreadWidth / 4);
                    else if (current === last) targetOffset = (spreadWidth / 4);
                    else targetOffset = 0;

                    appliedOffset = targetOffset;
                }

                bookEl.style.transform = `translateX(${targetOffset}px)`;
            };

            const scheduleCentering = () => {
                if (scheduled) return;
                scheduled = true;
                requestAnimationFrame(() => {
                    requestAnimationFrame(measureAndCenter);
                });
            };

            pageFlip.on('flip', scheduleCentering);
            window.addEventListener('resize', scheduleCentering);
            setTimeout(scheduleCentering, 0);
        });
    </script>

</body>
</html>
